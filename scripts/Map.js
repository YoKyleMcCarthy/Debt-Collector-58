const map_data = { "compressionlevel":-1,
 "height":20,
 "infinite":false,
 "layers":[
        {
         "data":[25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25,
            25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25,
            25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25,
            25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25,
            25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25,
            25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25,
            25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25,
            25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25,
            25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25,
            25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25,
            25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 3, 3, 3, 3, 25, 25, 3, 3, 3, 3, 3, 25, 25, 25, 25, 25, 25, 25, 25, 25,
            25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 3, 25, 25, 3, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25,
            25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 3, 25, 25, 3, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25,
            25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 3, 25, 25, 3, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25,
            25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 3, 25, 25, 3, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25,
            25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 3, 25, 25, 3, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25,
            25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 3, 25, 25, 3, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25,
            25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 3, 25, 25, 3, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25,
            25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 3, 25, 25, 3, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25,
            25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 3, 25, 25, 3, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25],
         "height":20,
         "id":2,
         "name":"Grass",
         "opacity":1,
         "type":"tilelayer",
         "visible":true,
         "width":30,
         "x":0,
         "y":0
        }, 
        {
         "data":[0, 0, 0, 0, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            0, 0, 0, 0, 19, 1, 50, 50, 50, 50, 50, 50, 50, 50, 4, 5, 19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            0, 0, 0, 0, 19, 9, 13, 58, 58, 58, 58, 58, 58, 58, 12, 13, 19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            0, 0, 0, 0, 19, 9, 10, 19, 19, 19, 19, 19, 19, 19, 9, 10, 19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            0, 0, 0, 0, 19, 9, 10, 19, 19, 19, 19, 19, 19, 19, 9, 10, 19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            0, 0, 0, 0, 19, 9, 10, 19, 19, 19, 19, 19, 19, 19, 9, 10, 19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            0, 0, 0, 0, 19, 9, 10, 19, 19, 19, 19, 19, 19, 19, 9, 10, 19, 19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            0, 0, 0, 0, 19, 9, 10, 19, 19, 19, 19, 33, 34, 19, 9, 10, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19,
            0, 0, 0, 0, 19, 9, 5, 50, 50, 50, 50, 50, 50, 50, 4, 5, 50, 50, 50, 50, 50, 50, 50, 50, 50, 50, 50, 50, 50, 50,
            0, 0, 0, 0, 19, 57, 58, 58, 58, 58, 58, 58, 58, 58, 12, 13, 58, 58, 58, 58, 58, 58, 58, 58, 58, 58, 58, 58, 58, 58,
            0, 0, 0, 0, 19, 19, 19, 19, 19, 19, 19, 19, 19, 34, 9, 10, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19,
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 19, 9, 10, 19, 0, 0, 0, 19, 0, 0, 19, 0, 0, 0, 0, 0, 0,
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 19, 9, 10, 19, 0, 0, 0, 19, 0, 0, 19, 0, 0, 0, 0, 0, 0,
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 19, 9, 10, 19, 0, 0, 0, 19, 0, 0, 19, 0, 0, 0, 0, 0, 0,
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 19, 9, 10, 19, 0, 0, 0, 19, 0, 0, 19, 0, 0, 0, 0, 0, 0,
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 19, 9, 10, 19, 0, 0, 0, 19, 0, 0, 19, 19, 19, 19, 19, 0, 0,
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 19, 9, 10, 19, 0, 0, 0, 19, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 19, 9, 10, 19, 0, 0, 0, 19, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 19, 9, 10, 19, 0, 0, 0, 19, 19, 19, 19, 19, 19, 19, 19, 0, 0,
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 19, 9, 10, 19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
         "height":20,
         "id":1,
         "name":"Area",
         "opacity":1,
         "type":"tilelayer",
         "visible":true,
         "width":30,
         "x":0,
         "y":0
        }, 
        {
         "data":[0, 0, 0, 0, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 67, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 67, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            0, 0, 0, 0, 3, 0, 0, 3, 3, 3, 3, 3, 3, 3, 0, 0, 67, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            0, 0, 0, 0, 3, 0, 0, 3, 0, 0, 0, 0, 0, 3, 0, 0, 67, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            0, 0, 0, 0, 3, 0, 0, 3, 0, 0, 0, 0, 0, 3, 0, 0, 67, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            0, 0, 0, 0, 3, 0, 0, 3, 0, 0, 0, 0, 0, 3, 0, 0, 67, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            0, 0, 0, 0, 3, 0, 0, 3, 3, 3, 3, 3, 3, 3, 0, 0, 67, 67, 67, 67, 67, 67, 67, 67, 67, 67, 67, 67, 67, 67,
            0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3,
            0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 12, 13, 0, 0, 0, 0, 0, 0, 3,
            0, 0, 0, 0, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 0, 0, 3, 3, 3, 3, 3, 9, 10, 3, 67, 67, 67, 67, 67, 67,
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 3, 0, 0, 0, 3, 9, 10, 3, 0, 0, 0, 0, 0, 0,
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 3, 0, 0, 0, 3, 9, 10, 3, 0, 0, 0, 0, 0, 0,
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 3, 0, 0, 0, 3, 9, 10, 3, 0, 0, 0, 0, 0, 0,
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 3, 0, 0, 0, 3, 9, 10, 3, 0, 0, 0, 0, 0, 0,
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 3, 0, 0, 0, 3, 9, 10, 3, 3, 3, 3, 3, 3, 3,
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 3, 0, 0, 0, 3, 9, 5, 50, 50, 50, 50, 50, 27, 3,
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 3, 0, 0, 0, 3, 17, 58, 58, 58, 58, 58, 58, 35, 3,
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 3, 0, 0, 0, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3,
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 3, 3, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
         "height":20,
         "id":3,
         "name":"Physics",
         "opacity":1,
         "type":"tilelayer",
         "visible":true,
         "width":30,
         "x":0,
         "y":0
        }],
 "nextlayerid":4,
 "nextobjectid":1,
 "orientation":"orthogonal",
 "renderorder":"right-down",
 "tiledversion":"1.11.2",
 "tileheight":32,
 "tilesets":[
        {
         "columns":8,
         "firstgid":1,
         "image":"SpriteSheet.png",
         "imageheight":256,
         "imagewidth":256,
         "margin":0,
         "name":"SpriteSheet",
         "spacing":0,
         "tilecount":64,
         "tileheight":32,
         "tilewidth":32
        }, 
        {
         "firstgid":65,
         "source":"SpriteSheet.tsx"
        }],
 "tilewidth":32,
 "type":"map",
 "version":"1.10",
 "width":30
}

/**
 * Represents the game map, handling drawing its layers.
 */
class Map {
    constructor(spritesheetImage) {
        this.data = map_data;
        this.spritesheet = spritesheetImage;

        this.tileWidth = this.data.tilewidth;
        this.tileHeight = this.data.tileheight;
        this.mapWidthInTiles = this.data.width;
        this.mapHeightInTiles = this.data.height;

        // The first tileset in your data defines the sprite sheet layout
        this.tileset = this.data.tilesets[0];
        this.tilesetColumns = this.tileset.columns;
    }

    /**
     * Calculates the source (x, y) coordinates on the spritesheet for a given tile ID.
     * @param {number} tileId - The global ID of the tile (1-based from Tiled).
     * @returns {{sx: number, sy: number} | null} The source coordinates, or null if ID is 0.
     */
    getTileSourceCoords(tileId) {
        // Tile IDs of 0 mean "no tile"
        if (tileId === 0) {
            return null;
        }

        // Tiled tile IDs are 1-based, so subtract 1 for 0-based indexing
        const zeroBasedId = tileId - 1;

        // Calculate the column and row of the tile in the spritesheet
        const col = zeroBasedId % this.tilesetColumns;
        const row = Math.floor(zeroBasedId / this.tilesetColumns);

        // Calculate the source x and y coordinates on the spritesheet
        const sx = col * this.tileWidth;
        const sy = row * this.tileHeight;

        return { sx, sy };
    }

    update(ctx) {
        // Map logic like movement, interactions, or animation updates would go here.
        // For a static map, this can remain empty.
    }

    /**
     * Extracts collision data from the "Physics" layer (tile ID 67) and returns an array of entity bounds.
     * @returns {Array<{name: string, x: number, y: number, w: number, h: number}>} Array of collision entity definitions.
     */
    getCollisionEntities() {
        const collisionData = [];
        // Find the "Physics" layer by name
        const physicsLayer = this.data.layers.find(layer => layer.name === "Physics");

        if (!physicsLayer || physicsLayer.type !== "tilelayer") {
            console.error("Physics layer not found or is not a tile layer.");
            return collisionData;
        }

        const tileData = physicsLayer.data;
        const collisionTileId = 3; // The ID of the impassable tile

        for (let i = 0; i < tileData.length; i++) {
            const tileId = tileData[i];

            if (tileId === collisionTileId) {
                // Calculate position of the tile in world coordinates
                const mapCol = i % this.mapWidthInTiles;
                const mapRow = Math.floor(i / this.mapWidthInTiles);

                const x = mapCol * this.tileWidth;
                const y = mapRow * this.tileHeight;

                collisionData.push({
                    name: "wall",
                    x: x,
                    y: y,
                    w: this.tileWidth,
                    h: this.tileHeight,
                });
            }
        }
        return collisionData;
    }

    /**
 * Draws all tile layers onto the canvas context, centered on the player.
 * @param {CanvasRenderingContext2D} ctx - The 2D rendering context of the canvas.
 * @param {Player} player - The Player object to center the view on.
 */
draw(ctx, player) {
    const canvasWidth = ctx.canvas.width;
    const canvasHeight = ctx.canvas.height;
    const multiplier = 6;
    
    ctx.save();

    // The dimensions *must* be scaled consistently.
    const scaledPlayerX = player.x * multiplier;
    const scaledPlayerY = player.y * multiplier;
    const scaledPlayerW = player.w * multiplier;
    const scaledPlayerH = player.h * multiplier;

    // Center of the scaled player on the map
    const playerCenterX = scaledPlayerX + scaledPlayerW / 2;
    const playerCenterY = scaledPlayerY + scaledPlayerH / 2;

    // Center the camera: shift the world opposite to the player's center,
    // plus half the canvas dimensions.
    const offsetX = canvasWidth / 2 - playerCenterX;
    const offsetY = canvasHeight / 2 - playerCenterY;
    
    ctx.translate(offsetX, offsetY);

    // Iterate through each tile layer defined in the map data
    for (const layer of this.data.layers) {
        // Only render 'tilelayer' types
        if (layer.type !== "tilelayer") {
            continue;
        }

        const tileData = layer.data;

        // Iterate through the tile data linearly
        for (let i = 0; i < tileData.length; i++) {
            const tileId = tileData[i];
            const coords = this.getTileSourceCoords(tileId);

            if (coords) {
                // Calculate the position of the tile on the map (destination)
                const mapCol = i % this.mapWidthInTiles;
                const mapRow = Math.floor(i / this.mapWidthInTiles);

                const dx = mapCol * this.tileWidth;
                const dy = mapRow * this.tileHeight;

                // Draw the tile using ctx.drawImage()
                ctx.drawImage(
                    this.spritesheet,     // image
                    coords.sx,            // sx: Source x-coordinate
                    coords.sy,            // sy: Source y-coordinate
                    this.tileWidth,       // sWidth: Source width
                    this.tileHeight,      // sHeight: Source height
                    dx * multiplier,      // dx: Destination x-coordinate (now affected by ctx.translate)
                    dy * multiplier,      // dy: Destination y-coordinate (now affected by ctx.translate)
                    this.tileWidth * multiplier, // dWidth: Destination width
                    this.tileHeight * multiplier // dHeight: Destination height
                );
            }
        }
    }
    
    // 4. Restore the canvas state (undo the translation)
    ctx.restore();
}
}

export default Map;
